#if 0
	shc Version 3.8.7, Generic Script Compiler
	Copyright (c) 1994-2009 Francisco Rosales <frosal@fi.upm.es>

	./shc -f create.sh 
#endif

static  char data [] = 
#define      msg2_z	19
#define      msg2	((&data[0]))
	"\215\012\325\213\320\062\066\157\143\313\052\227\207\303\315\040"
	"\262\205\213"
#define      msg1_z	42
#define      msg1	((&data[24]))
	"\031\067\332\244\121\000\022\352\104\354\337\370\247\326\000\130"
	"\323\236\073\115\366\237\104\170\036\231\116\304\075\051\215\206"
	"\201\131\256\072\342\274\002\202\056\155\173\210\132\154\340\072"
	"\146\065\375\206\134"
#define      date_z	1
#define      date	((&data[72]))
	"\346"
#define      chk1_z	22
#define      chk1	((&data[74]))
	"\131\037\252\211\264\040\167\144\221\066\024\332\225\331\141\024"
	"\276\017\003\126\172\170\360\173"
#define      rlax_z	1
#define      rlax	((&data[97]))
	"\247"
#define      pswd_z	256
#define      pswd	((&data[149]))
	"\255\347\022\314\135\237\345\225\171\212\346\263\360\033\261\167"
	"\167\343\231\346\156\321\072\307\114\330\062\061\342\376\056\220"
	"\346\100\134\103\340\101\330\132\313\277\015\274\332\276\064\122"
	"\242\316\071\212\007\151\236\273\325\275\370\045\176\275\303\103"
	"\110\336\025\313\022\244\160\154\312\334\351\251\260\026\370\242"
	"\214\324\054\223\075\312\117\023\210\107\070\006\004\374\112\115"
	"\332\137\031\355\003\211\132\316\145\103\167\026\132\160\270\346"
	"\104\344\172\201\257\311\225\067\020\316\075\025\312\210\142\245"
	"\347\173\223\353\005\355\271\153\061\061\201\213\241\071\161\345"
	"\035\354\147\314\265\374\003\306\312\101\334\225\311\076\072\261"
	"\272\315\234\277\273\125\052\354\206\253\167\047\344\351\015\002"
	"\325\164\316\213\161\322\122\073\023\056\320\335\155\013\216\047"
	"\330\053\347\223\200\021\200\007\275\367\057\242\340\074\244\266"
	"\261\163\101\042\106\223\135\131\302\056\067\057\071\306\127\022"
	"\361\076\246\161\120\046\171\016\035\250\260\376\345\125\264\226"
	"\311\366\270\017\212\026\151\114\105\240\174\176\146\324\220\130"
	"\022\067\312\143\135\103\161\173\353\042\172\321\170\056\147\101"
	"\045\040\120\257\067\271\374\174\132\170\372\301\114\213\031\137"
	"\302\343\303\037\047\065\233\022\127\025\343\317\104\113\020\151"
	"\153\141\030\020\237\163\330\354\114\013\035\057\012\114\277\361"
	"\215\033\065\156\135\015\310\051\315\325\345\250\224\032\373\067"
	"\350\065\110\210\250\041\164\365\054\222\044\067\336\343\050\154"
	"\377\135\332\134\153\242\206\070\170\153\341\015\206\334\104\157"
	"\021\215\367"
#define      opts_z	1
#define      opts	((&data[469]))
	"\000"
#define      text_z	1042
#define      text	((&data[694]))
	"\323\023\334\267\073\110\267\231\042\024\004\305\232\075\075\006"
	"\036\112\215\372\217\374\013\035\363\306\314\137\165\247\134\111"
	"\273\071\001\366\201\270\217\244\315\224\151\150\321\247\156\360"
	"\362\373\352\202\370\366\237\353\274\153\112\062\023\247\173\316"
	"\340\175\305\142\066\125\006\003\351\160\153\273\030\332\253\012"
	"\326\226\214\316\215\054\272\112\227\004\174\253\253\370\171\214"
	"\165\076\356\253\223\365\257\175\146\033\070\176\366\344\211\315"
	"\173\025\233\010\102\126\122\331\132\317\204\006\307\376\223\075"
	"\075\201\350\321\166\230\116\335\263\207\133\251\154\345\166\347"
	"\372\022\357\075\150\102\026\303\021\233\312\331\231\135\026\326"
	"\336\377\247\125\227\366\063\113\175\216\365\351\163\154\321\156"
	"\176\300\253\347\003\302\253\024\136\165\356\367\322\004\316\261"
	"\003\166\007\233\155\072\346\352\311\334\324\075\110\246\254\306"
	"\146\130\256\151\033\131\176\171\317\154\161\242\161\077\123\165"
	"\311\224\041\351\300\320\031\223\043\125\243\022\327\303\206\320"
	"\060\326\350\127\232\041\126\223\016\033\034\253\346\212\356\057"
	"\014\126\124\137\064\100\054\270\375\137\273\165\311\256\171\243"
	"\023\152\211\027\056\202\276\046\243\305\152\272\154\104\222\300"
	"\041\050\354\376\004\312\342\154\255\202\345\146\220\343\300\352"
	"\242\050\335\264\050\135\326\166\345\020\360\001\107\252\050\176"
	"\320\222\352\237\327\227\265\126\051\311\003\354\032\323\113\143"
	"\356\234\351\166\204\125\325\333\104\352\102\046\036\366\160\246"
	"\160\132\070\254\000\177\225\145\056\355\116\002\225\105\372\164"
	"\324\112\153\220\321\146\334\131\072\153\004\317\356\340\303\064"
	"\221\363\057\315\345\006\241\277\143\064\270\214\232\223\311\033"
	"\201\345\371\363\271\053\331\104\111\260\300\245\145\120\211\002"
	"\007\352\034\367\270\063\217\075\352\301\366\324\360\175\172\217"
	"\163\206\035\323\012\201\004\005\223\255\012\222\244\112\325\366"
	"\314\161\262\136\061\236\153\237\066\032\174\021\152\027\331\364"
	"\301\322\233\322\113\366\076\157\263\343\007\172\363\213\241\357"
	"\050\050\350\260\371\252\354\236\263\074\122\250\151\161\070\005"
	"\153\016\363\007\115\062\037\143\352\064\276\316\232\160\222\321"
	"\027\014\306\200\003\334\014\112\173\300\020\201\162\304\100\214"
	"\122\105\347\152\126\343\340\275\351\040\333\276\031\103\201\350"
	"\166\117\034\141\114\326\305\273\320\345\142\127\050\131\362\367"
	"\176\203\141\351\245\370\043\151\337\156\061\133\020\345\061\013"
	"\361\037\243\023\036\375\152\161\144\250\112\325\270\065\264\331"
	"\253\126\303\072\024\135\077\337\364\361\326\316\211\001\125\237"
	"\306\153\323\302\207\302\261\217\016\102\230\270\321\040\235\271"
	"\016\261\136\366\112\021\150\245\104\071\072\312\064\124\136\071"
	"\014\375\117\377\136\077\224\100\371\206\064\303\250\021\302\123"
	"\204\227\007\204\121\234\031\173\214\016\103\015\152\051\334\122"
	"\232\045\205\034\270\177\333\026\106\303\330\266\232\355\137\372"
	"\173\124\273\236\203\000\142\141\060\265\360\072\052\156\364\025"
	"\135\011\376\211\144\114\201\103\341\035\053\325\157\023\061\221"
	"\172\237\247\126\320\321\256\375\371\227\165\330\274\254\335\177"
	"\077\205\130\321\130\224\360\260\116\223\021\006\216\227\314\214"
	"\037\363\140\026\312\360\345\261\006\325\377\013\321\272\054\262"
	"\327\110\307\170\250\261\045\043\167\327\111\142\126\143\373\230"
	"\367\210\102\063\270\355\065\072\033\141\061\150\172\142\174\170"
	"\350\306\367\200\071\200\217\265\032\304\217\353\363\157\355\117"
	"\064\055\333\231\130\333\373\044\307\173\066\346\124\303\325\013"
	"\360\023\000\312\274\157\347\026\347\131\354\001\221\350\375\006"
	"\050\025\055\062\340\050\347\210\023\212\360\143\063\156\267\021"
	"\252\117\226\235\171\110\121\353\372\352\053\036\013\243\265\035"
	"\342\306\152\171\360\235\142\065\335\236\332\144\323\044\150\047"
	"\037\013\316\256\072\262\353\163\051\126\346\105\251\343\101\105"
	"\335\033\340\346\365\213\010\227\232\060\363\170\220\270\322\200"
	"\024\344\104\213\117\323\066\231\003\344\357\050\110\046\223\134"
	"\331\306\325\146\245\177\323\331\227\235\114\062\056\347\330\111"
	"\075\076\052\004\155\154\127\153\063\104\273\356\210\054\156\025"
	"\216\070\070\215\356\021\211\315\104\374\053\356\312\075\140\361"
	"\147\376\347\150\043\331\104\315\173\312\015\211\004\341\161\351"
	"\000\240\042\012\207\050\042\307\224\103\227\176\313\257\077\354"
	"\004\052\071\124\013\006\300\036\304\005\017\033\135\334\110\333"
	"\247\000\101\313\327\007\370\233\055\242\367\176\137\063\124\047"
	"\063\311\012\247\037\063\325\265\344\323\257\357\223\215\154\262"
	"\173\222\207\246\337\077\132\023\347\001\256\322\303\046\011\157"
	"\125\176\221\253\236\344\327\235\167\157\101\217\346\001\300\277"
	"\122\005\076\006\336\047\213\142\056\137\025\366\042\223\072\116"
	"\066\003\217\013\207\054\021\075\067\326\053\347\070\254\145\326"
	"\234\125\354\211\005\156\376\337\346\346\070\343\136\156\212\330"
	"\141\171\305\057\337\160\061\031\144\275\043\067\321\377\240\241"
	"\340\066\204\244\261\142\374\200\246\132\274\351\077\247\065\215"
	"\026\075\031\255\147\047\214\162\006\161\141\012\241\370\017\366"
	"\151\232\171\204\167\254\376\003\321\051\257\101\244\332\001\077"
	"\334\005\052\010\274\360\111\336\001\022\326\241\233\377\071\165"
	"\340\052\131\235\174\353\046\074\133\306\030\375\346\107\132\034"
	"\307\072\256\111\325\071\232\262\254\375\005\166\360\115\250\250"
	"\060\300\266\133\020\043\226\367\016\140\323\343\235\033\211\112"
	"\342\360\242\221\131\276\353\330\067\272\104\250\134\266\350\260"
	"\053\237\013\073\303\242\063\321\002\007\265\240\043\076\352\006"
	"\056\215\227\210\114\202\141\203\075\246\054\231\134\025\111\207"
	"\265\125\303\170\370\367\111\372\376\376\233\041\075\205\050\154"
	"\023\300\364\137\103\125\343\200\373\020\031\127\045\143\337\333"
	"\271\242\123\261\231\235\253\230\233\106\272\331\314\342\105\340"
	"\242\071\100\345\217\043\146\213\064\177\343\132\343\302\065\234"
	"\145\210\115\376\045\371\226\301\100\121\232\014\063\337\355\326"
	"\031\055\274\251\121\042\064\205\242\027\337\205\331\024\041\076"
	"\235\157\075\302\150\324\203\250\045\036\265\130\376\242\057\030"
	"\320\353\301\041\015\365\247\260\015\206\065\346\233\127\045\070"
	"\307\143\373\057\067\177\330\134\235\216\265\234\061\345\264\001"
	"\320\165\042\336\152\311\216\167\120\304\136\353\033\204\044\342"
	"\347\037\022\037\236\353\174\074\171\062\330\252\027\214\254\347"
	"\001\316\306\154\230\125\344\351\031\103\324\065\307\371\030\257"
	"\031\052\316\270"
#define      shll_z	10
#define      shll	((&data[1994]))
	"\363\252\271\041\335\304\113\134\071\250\220\174"
#define      tst2_z	19
#define      tst2	((&data[2007]))
	"\132\264\241\255\205\303\301\026\331\114\035\366\041\053\310\271"
	"\305\221\054\256\347\173"
#define      xecc_z	15
#define      xecc	((&data[2030]))
	"\310\117\133\366\074\101\355\033\170\045\351\146\170\023\370\107"
	"\016\227"
#define      chk2_z	19
#define      chk2	((&data[2047]))
	"\360\103\003\256\225\152\216\321\076\256\151\253\331\172\201\220"
	"\045\270\110\177\015\346\270"
#define      inlo_z	3
#define      inlo	((&data[2069]))
	"\133\112\300"
#define      lsto_z	1
#define      lsto	((&data[2072]))
	"\216"
#define      tst1_z	22
#define      tst1	((&data[2074]))
	"\314\123\174\041\200\212\063\153\250\303\226\325\031\200\113\143"
	"\004\266\070\133\325\051\067\320\375\232"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	0	/* Define as 1 to enable ptrace the executable */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask  = (unsigned long)&chkenv;
	mask ^= (unsigned long)getpid() * ~mask;
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;

	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	ret = chkenv(argc);
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		if (text_z < hide_z) {
			/* Prepend spaces til a hide_z script size. */
			scrpt = malloc(hide_z);
			if (!scrpt)
				return 0;
			memset(scrpt, (int) ' ', hide_z);
			memcpy(&scrpt[hide_z - text_z], text, text_z);
		} else {
			scrpt = text;	/* Script text */
		}
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, argv[0]);
		} else {
			scrpt = argv[0];
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
